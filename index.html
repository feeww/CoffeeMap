<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CoffeeMap OSM</title>
<link rel="stylesheet" href="styles/style.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
  /* Мини-карта */
  #map-wrapper {
    width: 350px;
    height: 220px;
    position: relative;
    cursor: pointer;
    transition: .25s ease;
    border-radius: 12px;
    overflow: hidden;
  }

  /* Карта внутри */
  #map {
    width: 100%;
    height: 100%;
  }

  /* Фуллскрин слой */
  #map-fullscreen {
    position: fixed;
    inset: 0;
    background: #000000c7;
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  #map-fullscreen.active {
    display: flex;
  }

  #map-expanded {
    width: 90vw;
    height: 80vh;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
  }

  /* Крестик */
  #closeMap {
    position: absolute;
    top: 15px;
    right: 15px;
    z-index: 10000;
    background: #ffffffd2;
    padding: 5px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 20px;
    font-weight: bold;
    transition: .2s ease;
  }
  #closeMap:hover {
    background: white;
  }
</style>
</head>
<body>

<header>
  <img src="img/logo-text.png" alt="CoffeeMap" class="logo">
</header>

<main>

  <!-- Мини-карта -->
  <div id="map-wrapper">
    <div id="map"></div>
  </div>

  <!-- Фуллскрин карта -->
  <div id="map-fullscreen">
    <div id="closeMap">×</div>
    <div id="map-expanded"></div>
  </div>

</main>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* -----------------------------------------
   Общая логика Leaflet
------------------------------------------*/

delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://unpkg.com/leaflet/dist/images/marker-icon-2x.png',
  iconUrl: 'https://unpkg.com/leaflet/dist/images/marker-icon.png',
  shadowUrl: 'https://unpkg.com/leaflet/dist/images/marker-shadow.png',
});

const center = [50.45, 30.52];

/* Мини карта */
const map = L.map('map', {
  center,
  zoom: 15,
  minZoom: 13,
  maxZoom: 17
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

let markersLayer = L.layerGroup().addTo(map);

/* Основная функция подгрузки */
async function loadPoints(targetMap, layer) {
  if(targetMap.getZoom() < 14){
    layer.clearLayers();
    return;
  }

  const b = targetMap.getBounds();
  const query = `
    [out:json];
    (
      node["amenity"="cafe"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
      node["amenity"="restaurant"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
      node["amenity"="fast_food"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
      node["amenity"="bar"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
      node["amenity"="pub"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
      node["amenity"="food_court"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
    );
    out;
  `;

  try {
    const response = await fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query));
    const data = await response.json();
    layer.clearLayers();

    data.elements.forEach(p => {
      const tags = p.tags || {};
      const name = tags.name || "Без назви";
      const phone = tags.phone ? `Телефон: ${tags.phone}` : '';
      const website = tags.website ? `<a href="${tags.website}" target="_blank">${tags.website}</a>` : '';
      const hours = tags.opening_hours ? `Часы работы: ${tags.opening_hours}` : '';
      const cuisine = tags.cuisine ? `Кухня: ${tags.cuisine}` : '';

      const addressParts = [];
      if(tags['addr:housenumber']) addressParts.push(tags['addr:housenumber']);
      if(tags['addr:street']) addressParts.push(tags['addr:street']);
      if(tags['addr:city']) addressParts.push(tags['addr:city']);
      if(tags['addr:postcode']) addressParts.push(tags['addr:postcode']);
      const address = addressParts.length ? `Адрес: ${addressParts.join(', ')}` : '';

      const popupContent = `<b>${name}</b>${address ? `<br>${address}` : ''}${phone ? `<br>${phone}` : ''}${hours ? `<br>${hours}` : ''}${cuisine ? `<br>${cuisine}` : ''}${website ? `<br>${website}` : ''}`;

      L.marker([p.lat, p.lon]).addTo(layer).bindPopup(popupContent);
    });
  } catch(err){
    console.error("Ошибка Overpass:", err);
  }
}

loadPoints(map, markersLayer);
map.on("moveend", () => loadPoints(map, markersLayer));

/* -----------------------------------------
   Фуллскрин карта
------------------------------------------*/
const mapFullscreen = document.getElementById("map-fullscreen");
const mapWrapper = document.getElementById("map-wrapper");
const closeBtn = document.getElementById("closeMap");

let mapBig;  
let bigLayer;

/* Открытие */
mapWrapper.onclick = () => {
  mapFullscreen.classList.add("active");

  if(!mapBig){
    mapBig = L.map("map-expanded", {
      center,
      zoom: 15,
      minZoom: 13,
      maxZoom: 18
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
      .addTo(mapBig);

    bigLayer = L.layerGroup().addTo(mapBig);

    loadPoints(mapBig, bigLayer);
    mapBig.on("moveend", () => loadPoints(mapBig, bigLayer));
  }

  setTimeout(() => mapBig.invalidateSize(), 200);
};

/* Закрытие */
function closeFullscreen() {
  mapFullscreen.classList.remove("active");
}

closeBtn.onclick = closeFullscreen;

/* ESC для закрытия */
document.addEventListener("keydown", e => {
  if (e.key === "Escape") closeFullscreen();
});
</script>

</body>
</html>
